---
title: "HW1"
author: "SES"
date: "2025-09-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "~/projects/eco_genomics_2025/population_genomics")
```

1. Import our libraries for plotting 
```{r}
#load plotting libraries 
library(tidyverse)
library(ggplot2)
library(dplyr)
library(ggpubr)
library(qqman)
```
2.Using Nucleotide diversity to find selection signatures
```{r} 
setwd("myresults/ANGSD/diversity")

theta <- read.table("_ALL_win50000_step50000.thetas", sep = "\t", header = T)

head(theta)
#Scaling Watterson's theta by nSites
theta$tWsite = theta$tW/theta$nSites 

#Scaling Pi by nSites
theta$tPsite = theta$tP/theta$nSites 

#check!
head(theta)
summary(theta)

#rearrange theta table 
theta2 = theta %>% 
  arrange(Chr, WinCenter) %>%
  filter(Chr > 100)

#compare pi and thetaW together and look for deviation 

#subsetting rows that are evidence of selective sweep
theta2[which(theta2$Tajima < -1.5 & theta2$tPsite < 0.001),]

summary(theta2)
sum(theta2$nSites)

```

3. Using PCA to find selection signatures 
```{r}
setwd("myresults/ANGSD/PCA_ADMIX")

#making the PCA with just the Red Spruce 

allRScov <- as.matrix(read.table("allRS_poly_K3.cov"))

allRSPCA <- eigen(allRScov)

var <- round(allRSPCA$values/sum(allRSPCA$values),3)

var[1:3]

#Bring in the bam list files and extract sample name information. Line 40 is the data frame with the list of names. The last number is the number of samples (1-95)
names <- read.table("allRS_bam.list")
names <- unlist(strsplit(basename(as.character(names[,1])), split = ".sorted.rmdup.bam"))
split = strsplit(names, "_")
pops <- data.frame(names[1:95], do.call(rbind, split[1:95]))
names(pops) = c("Ind", "Pop", "Row", "Col")

s <- read.table("allRS_poly_K3.selection")

# convert test statistic to p-value
pval_PC1 <- as.data.frame(1-pchisq(s[,1],1))
names(pval_PC1) = "p_PC1"

pval_PC2 <- as.data.frame(1-pchisq(s[,2],1))
names(pval_PC2) = "p_PC2"

#read in the sites: data on the snp positions themselves. Pairs the site information with sites that were selected for analysis in the outlier test.

PCAngsd_sites <- read.table("allRS_poly_K3.sites")
MAF_all_sites <- read.table("/gpfs1/cl/ecogen/pbio6800/PopulationGenomics/ANGSD/allRS_poly.mafs.gz", header=T)

pos_filtered <- cbind(MAF_all_sites,PCAngsd_sites)[which(PCAngsd_sites==1),]

dim(pos_filtered)
```
4. comparing significant values of the PC axis with Tajima's D and Pi 
```{r}
#evidence of selective sweep (Taijima's D and Pi)

#Checking colnames of tajima'sD and Pi (Theta2 table)
TDPi=theta2
colnames(TDPi)

#checking colnames of PC axis selection signatures
PCaxis=MAF_all_sites
#colnames(PCaxis)
PCaxis <- rename(PCaxis, Chr=chromo)
colnames(PCaxis)

#overlap of sites in both 
common_IDs <- intersect(TDPi$Chr, PCaxis$Chr)
head(common_IDs)


  

```

